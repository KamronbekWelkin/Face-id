<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Face Attendance (Mobile) — SPEKTR</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:0;background:#f6f8fb;color:#111}
    header{padding:12px 16px;background:white;box-shadow:0 1px 0 rgba(0,0,0,.06);display:flex;align-items:center;gap:12px}
    main{padding:12px}
    #video{width:100%;max-height:55vh;background:#000;object-fit:cover}
    .row{display:flex;gap:8px;margin-top:10px}
    button{padding:10px;border-radius:8px;border:0;background:#2563eb;color:white;font-weight:600;flex:1}
    .muted{color:#666;font-size:.95rem}
    input[type=text]{padding:8px;border-radius:8px;border:1px solid #ddd;flex:1}
    .card{background:white;padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(16,24,40,.06)}
    #log{max-height:220px;overflow:auto;margin-top:10px;font-family:monospace;background:#0f172a;color:#fff;padding:8px;border-radius:8px}
  </style>
</head>
<body>
  <header>
    <div style="font-weight:700">Face Attendance — Mobil</div>
    <div style="margin-left:auto;font-size:.9rem;color:#666">SPEKTR</div>
  </header>

  <main>
    <div class="card">
      <video id="video" autoplay muted playsinline></video>

      <div class="row" style="margin-top:10px;">
        <input id="nameInput" type="text" placeholder="Xodim ismi (enroll uchun)" />
        <button id="enrollBtn">Enroll (ro‘yxatdan o‘tkazish)</button>
      </div>

      <div class="row">
        <button id="startScan">Boshlash — Scan</button>
        <button id="stopScan" style="background:#ef4444">To‘xtat</button>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <label class="muted">Saqlash:</label>
        <button id="downloadCsv" style="flex:0 0 auto;background:#10b981">CSV yuklab olish</button>
        <button id="clearDb" style="flex:0 0 auto;background:#f97316">DB tozalash</button>
      </div>

      <div id="log" aria-live="polite"></div>

      <p class="muted" style="margin-top:10px">Qisqacha: avval xodimni ro’yxatga oling (Enroll). Keyin "Boshlash" tugmasini bosing — ortiqcha kamera orqa kamerani ishga tushiradi va yuzni aniqlaydi. Tanish yuz topilsa, Attendance ga vaqt yoziladi (localStorage yoki serverga yuborish mumkin).</p>

    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script>
    // ---------- CONFIG ----------
    const MODEL_URL = './models'
    const MATCH_THRESHOLD = 0.5

    // ---------- UI ----------
    const video = document.getElementById('video')
    const enrollBtn = document.getElementById('enrollBtn')
    const startScan = document.getElementById('startScan')
    const stopScan = document.getElementById('stopScan')
    const nameInput = document.getElementById('nameInput')
    const logEl = document.getElementById('log')
    const downloadCsv = document.getElementById('downloadCsv')
    const clearDb = document.getElementById('clearDb')

    let stream = null
    let scanning = false
    let labeledDescriptors = [] // [{name, descriptors: [Float32Array,...]}]

    function readAttendance(){ return JSON.parse(localStorage.getItem('attendance')||'[]') }
    function saveAttendance(arr){ localStorage.setItem('attendance',JSON.stringify(arr)) }
    function pushAttendance(name){
      const arr = readAttendance()
      arr.push({name, time: new Date().toISOString()})
      saveAttendance(arr)
      log(`✅ ${name} — ${new Date().toLocaleString()}`)
    }

    function log(msg){
      const t = new Date().toLocaleTimeString()
      logEl.innerText = `[${t}] ${msg}\n${logEl.innerText}`
    }

    async function startCamera(){
      if(stream) return
      try{
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false})
        video.srcObject = stream
        await video.play()
        log('Kamera ishga tushdi')
      }catch(e){
        log('Kamera ochishda xato: '+e.message)
      }
    }
    function stopCamera(){
      if(!stream) return
      stream.getTracks().forEach(t=>t.stop())
      stream = null
      video.srcObject = null
      log('Kamera to‘xtatildi')
    }

    async function loadModels(){
      log('Model fayllari yuklanmoqda...')
      await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL)
      await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL)
      await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
      log('Model fayllari yuklandi')
    }

    async function enrollCurrent(name){
      if(!name) { alert('Ism kiriting'); return }
      log(`Enroll boshlandi: ${name}`)
      const descriptors = []
      for(let i=0;i<6;i++){
        await new Promise(r=>setTimeout(r,500))
        const detection = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor()
        if(detection){
          descriptors.push(Array.from(detection.descriptor))
          log(`captured ${i+1}/6`)
        } else {
          log(`Yuz topilmadi ${i+1}`)
        }
      }
      if(descriptors.length===0){ log('Enroll muvaffaqiyatsiz — yuz olinmadi'); return }
      const db = JSON.parse(localStorage.getItem('labeledDescriptors')||'[]')
      db.push({name, descriptors})
      localStorage.setItem('labeledDescriptors', JSON.stringify(db))
      labeledDescriptors = db
      log(`✅ ${name} ro'yxatga olindi (${descriptors.length} descriptorlar)`)
    }

    function loadLabeledDescriptorsFromStorage(){
      const db = JSON.parse(localStorage.getItem('labeledDescriptors')||'[]')
      labeledDescriptors = db
      log(`Yuklandi: ${db.length} ta ro'yxatga olingan xodim`)
    }

    async function startRecognitionLoop(){
      if(scanning) return
      scanning = true
      await startCamera()
      log('Scan boshlanadi...')

      const labeled = labeledDescriptors.map(ld=> new faceapi.LabeledFaceDescriptors(ld.name, ld.descriptors.map(d=>new Float32Array(d))))
      const faceMatcher = new faceapi.FaceMatcher(labeled, MATCH_THRESHOLD)

      while(scanning){
        const detection = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor()
        if(detection && labeled.length>0){
          const best = faceMatcher.findBestMatch(detection.descriptor)
          if(best.label !== 'unknown'){
            pushAttendance(best.label)
            await new Promise(r=>setTimeout(r,3000))
          } else {
            // unknown face
          }
        }
        await new Promise(r=>setTimeout(r,300))
      }
    }

    function downloadAttendanceCSV(){
      const arr = readAttendance()
      if(arr.length===0){ alert('Attendance bo\\'sh'); return }
      const lines = ['name,time']
      arr.forEach(r=>lines.push(`${r.name},${r.time}`))
      const blob = new Blob([lines.join('\\n')], {type:'text/csv'})
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url; a.download = `attendance_${new Date().toISOString().slice(0,19)}.csv`
      a.click()
      URL.revokeObjectURL(url)
    }

    (async ()=>{
      await loadModels()
      loadLabeledDescriptorsFromStorage()
    })()

    enrollBtn.addEventListener('click', async ()=>{
      const name = nameInput.value.trim()
      await startCamera()
      await enrollCurrent(name)
      stopCamera()
    })

    startScan.addEventListener('click', async ()=>{
      await loadLabeledDescriptorsFromStorage()
      startRecognitionLoop()
    })

    stopScan.addEventListener('click', ()=>{
      scanning = false
      stopCamera()
      log('Scan to‘xtatildi')
    })

    downloadCsv.addEventListener('click', downloadAttendanceCSV)
    clearDb.addEventListener('click', ()=>{
      if(confirm('Local DB tozalansha?')){
        localStorage.removeItem('attendance')
        localStorage.removeItem('labeledDescriptors')
        labeledDescriptors = []
        log('Local DB tozalandi')
      }
    })

    window.addEventListener('beforeunload', ()=>{ stopCamera() })
  </script>
</body>
</html>
